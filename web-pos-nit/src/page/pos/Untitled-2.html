


import React, { forwardRef, useRef } from "react";
import { getProfile } from "../../store/profile.store";
import logo from "../../assets/petronas_black2.png";

const DeliveryNotePrint = forwardRef((props, ref) => {
  const profile = getProfile();
  const iframeRef = useRef(null);

  // Number to Khmer words conversion function remains the same
  const numberToKhmerWords = (number, unit = '') => {
    const units = ["", "មួយ", "ពីរ", "បី", "បួន", "ប្រាំ", "ប្រាំមួយ", "ប្រាំពីរ", "ប្រាំបី", "ប្រាំបួន"];
    const tens = ["", "ដប់", "ម្ភៃ", "សាមសិប", "សែសិប", "ហាសិប", "ហុកសិប", "ចិតសិប", "ប៉ែតសិប", "កៅសិប"];
    const scales = ["", "ពាន់", "ម៉ឺន", "លាន", "ដប់លាន", "រយលាន", "ពាន់លាន"];

    // Handle unit
    const getUnitInKhmer = (unit) => {
      const cleanUnit = unit?.trim().toUpperCase() || '';
      switch (cleanUnit) {
        case 'L': return 'លីត្រ';
        case 'T': return 'តោន';
        case 'KG': return 'គីឡូក្រាម';
        case 'G': return 'ក្រាម';
        case 'M': return 'ម៉ែត្រ';
        case 'CM': return 'សង់ទីម៉ែត្រ';
        case 'MM': return 'មីលីម៉ែត្រ';
        default: return unit;
      }
    };

    if (number === null || number === undefined || isNaN(number)) return '';
    if (number === 0) return 'សូន្យ' + getUnitInKhmer(unit);

    const wholePart = Math.floor(number);
    const decimalPart = Math.round((number - wholePart) * 100);

    const convertLessThanOneMillion = (num) => {
      if (num === 0) return "";
      let str = "";

      if (num >= 100000) {
        const hundredThousands = Math.floor(num / 100000);
        str += units[hundredThousands] + "រយ";
        num %= 100000;
      }

      if (num >= 10000) {
        const tenThousands = Math.floor(num / 10000);
        str += tens[tenThousands];
        num %= 10000;
      }

      if (num >= 1000) {
        const thousands = Math.floor(num / 1000);
        str += units[thousands] + "ពាន់";
        num %= 1000;
      }

      if (num >= 100) {
        const hundreds = Math.floor(num / 100);
        str += units[hundreds] + "រយ";
        num %= 100;
      }

      if (num >= 10) {
        const ten = Math.floor(num / 10);
        str += tens[ten];
        num %= 10;
      }

      if (num > 0) {
        str += units[num];
      }

      return str;
    };

    let wholeWords = "";
    let remaining = wholePart;

    if (remaining === 0) {
      wholeWords = "សូន្យ";
    } else {
      const millions = Math.floor(remaining / 1000000);
      remaining %= 1000000;

      if (millions > 0) {
        wholeWords += convertLessThanOneMillion(millions) + "លាន";
      }

      wholeWords += convertLessThanOneMillion(remaining);
    }

    let decimalWords = "";
    if (decimalPart > 0) {
      decimalWords = " ចុច ";
      if (decimalPart < 10) {
        decimalWords += units[0] + units[decimalPart];
      } else {
        const ten = Math.floor(decimalPart / 10);
        const unit = decimalPart % 10;
        decimalWords += tens[ten] + (unit !== 0 ? units[unit] : "");
      }
    }

    // Final result with unit
    const unitText = getUnitInKhmer(unit);
    return (wholeWords + decimalWords).trim() + (unitText ? unitText : '');
  };

  const getUnitInKhmer = (unit = '') => {
    const cleanUnit = unit?.trim().toUpperCase() || '';
    switch (cleanUnit) {
      case 'L': return 'លីត្រ';
      case 'T': return 'តោន';
      case 'KG': return 'គីឡូក្រាម';
      case 'G': return 'ក្រាម';
      case 'M': return 'ម៉ែត្រ';
      case 'CM': return 'សង់ទីម៉ែត្រ';
      case 'MM': return 'មីលីម៉ែត្រ';
      default: return unit;
    }
  };

  const formatPhoneNumber = (phone) => {
    if (!phone) return "";
    return phone
      .split("/")
      .map((num) => {
        const digits = num.replace(/\D/g, "");
        if (digits.length === 10) {
          return `${digits.slice(0, 3)} ${digits.slice(3, 6)} ${digits.slice(6)}`;
        }
        return num.trim();
      })
      .join(" / ");
  };

  const printContent = (printData) => {
    const { data, items } = printData || {};
    if (!iframeRef.current) return;

    const doc = iframeRef.current.contentDocument || iframeRef.current.contentWindow.document;

    const processedItems = (items || []).map(item => {
      let quantity = item.quantity || 0;
      let unit = item.unit || '';
      if (typeof quantity === 'string') {
        const match = quantity.match(/^(\d+(?:\.\d+)?)([A-Za-z]*)$/);
        if (match) {
          quantity = parseFloat(match[1]);
          if (match[2]) unit = match[2];
        } else {
          quantity = parseFloat(quantity) || 0;
        }
      }
      return {
        ...item,
        quantity,
        khmer_word: numberToKhmerWords(quantity, unit)
      };
    });

    const totalQuantity = processedItems.reduce((sum, item) => sum + item.quantity, 0);
    const totalKhmerWord = numberToKhmerWords(totalQuantity, processedItems[0]?.unit || '');

    const tableRows = processedItems.map((item, idx) => `
        <tr>
          <td>${idx + 1}</td>
          <td class="wrap-text"><span class="metal">${item?.category_name || ''}</span></td>
          <td>${item?.unit || ''}</td>
          <td>${parseFloat(item?.quantity || 0).toLocaleString('en-US')}</td>
          <td>....................................</td>
          <td class="wrap-text">${item?.note || ''}</td>
        </tr>
      `).join('');

    const blankRowsNeeded = 5; // More blank rows for a cleaner look
    for (let i = 0; i < blankRowsNeeded; i++) {
      tableRows += `
        <tr class="empty-row">
          <td>&nbsp;</td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
        </tr>
      `;
    }

    // HTML template for the delivery note
    const html = `
      <!DOCTYPE html>
      <html lang="km">
      <head>
        <meta charset="UTF-8">
        <title>Delivery Note - ${mockData?.delivery_number || ''}</title>
        <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@100;300;400;700;900&family=Fasthand&family=Freehand&family=Khmer&family=Metal&family=Moul&family=Siemreap&display=swap" rel="stylesheet">
        <style>
          @page { size: A4; margin: 0; }
          html, body {
            width: 210mm;
            height: 297mm;
            margin: 0;
            padding: 0;
            font-family: 'Siemreap', 'Khmer OS System', Arial, sans-serif;
            font-size: 11pt;
          }
          .metal { font-family: 'Metal', 'Khmer OS', 'Khmer OS System', sans-serif; font-weight: 500; }
          .metal_address {
            font-family: 'Metal', 'Khmer OS', 'Khmer OS System', sans-serif;
            font-size: 10pt;
            font-weight: 500;
          }
          .siemreap-bold {
            font-family: 'Siemreap', sans-serif;
            font-weight: bold;
            color: #454545;
          }
          .delivery-note-print {
            width: 190mm;
            height: 277mm;
            padding: 10mm;
            margin: auto;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
          }
          .header-container {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 10mm;
          }
          .logo-section {
            width: 25%;
            text-align: left;
          }
          .logo-image {
            width: 100px;
            height: auto;
            object-fit: contain;
          }
          .header-section {
            width: 75%;
            text-align: center;
          }
          .header-title {
            font-family: 'Moul', 'Khmer OS Muol Light', sans-serif;
            font-size: 14pt;
            font-weight: 900;
            margin: 0 0 2mm 0;
            line-height: 1.3;
          }
          .header-number {
            font-family: 'Siemreap', 'Khmer OS', sans-serif;
            font-size: 12pt;
            margin: 0;
          }
          .info-container { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 5mm; 
          }
          .info-left, .info-right { 
            width: 48%; 
          }
          .info-left p, .info-right p { 
            margin: 2mm 0; 
          }
          .customer-info-grid {
            display: grid;
            grid-template-columns: auto auto 1fr;
            width: 100%;
          }
          .customer-info-grid p {
            margin: 3px 0;
          }
          .customer-info-grid .label {
            text-align: left;
            margin-right: 5px;
          }
          .customer-info-grid .separator {
            margin: 0 5px;
          }
          .customer-info-grid .value {
            text-align: left;
            word-break: break-word;
            max-width: 80%;
          }
          .wrap-text {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
          }
          table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 10pt; 
            margin: 0 auto;
          }
          th { 
            border: 1px solid black; 
            padding: 1mm;
            text-align: center; 
          }
          td { 
            border: 1px solid black; 
            padding: 2mm;
            text-align: center;
            height: 10mm;
          }
          .empty-row td {
            height: 10mm; /* Height for empty rows */
          }
          .dotted-quantity { 
            letter-spacing: 1px; 
          }
          .note-section { 
            margin-top: 6mm; 
          }
          .signatures {
            display: flex;
            justify-content: space-between;
            margin-top: 10mm;
          }
          .signature-block { 
            width: 25%; 
            text-align: center; 
          }
          .signature-line { 
            border-bottom: 1px solid black; 
            margin-top: 20mm; 
            margin-bottom: 5mm; 
          }
          .moul-regular {
            font-family: "Moul", serif;
            font-weight: 200;
          }
          .document-footer {
            width: 100%;
            margin-top: 10mm;
            border-top: 1px dotted #000000;
            padding-top: 4mm;
            display: flex;
            justify-content: space-between;
            font-size: 10pt;
          }
          .footer-left {
            display: flex;
            width: 70%;
          }
          .footer-right {
            width: 30%;
            text-align: right;
            padding-right: 10mm;
          }
          .footer-item {
            flex: 1;
            text-align: left;
            padding: 0 2mm;
          }
          .footer-label {
            font-family: 'Siemreap', 'Khmer OS System', sans-serif;
            font-weight: bold;
            display: inline-block;
            margin-right: 1mm;
          }
          .footer-value {
            font-family: 'Metal', 'Khmer OS', 'Khmer OS System', sans-serif;
            font-weight: normal;
          }
          small {
            font-size: 8pt;
            color: #999;
            margin-top: -4px;
          }
        </style>
      </head>
      <body>
        <div class="delivery-note-print">
          <div>
            <div class="header-container">
              <div class="logo-section">
                <div class="logo-placeholder" style="width: 100px; height: 100px; background-color: #f0f0f0; display: flex; justify-content: center; align-items: center;">Logo</div>
              </div>
              <div class="header-section">
                <h2 class="header-title">ប័ណ្ណដឹកជញ្ជូនប្រេងឥន្ធន</h2>
                <p class="header-number">លេខ៖ ${mockData?.delivery_number || ''}</p>
              </div>
            </div>

            <div class="info-container">
              <div class="info-left">
                <p><span class="siemreap-bold">ចេញពីពោងស្តុកលេខ៖ </span><span class="metal">${profile?.branch_name || 'ស្រុកស្រែអំបិល'}</span></p>
                <p><span class="siemreap-bold">អាសយដ្ឋាន៖</span><span class="metal_address wrap-text"> ${profile?.address || 'ផ្លូវជាតិលេខ ៣, ភូមិត្រពាំងចាន់, ឃុំបន្ទាយមាស, ស្រុកស្រែអំបិល, ខេត្តកោះកុង'}</span></p>
                <p><span class="siemreap-bold">ទូរស័ព្ទ៖</span><span class="metal">${formatPhoneNumber(profile?.phone) || '015 887 917 / 069 887 917'}</span></p>
                <p><span class="siemreap-bold">អត្តសញ្ញាណកម្មសារពើពន្ធ៖</span><span class="metal">${profile?.tax_id || 'L001-100106390'}</span></p>
              </div>
              
              <div class="info-right">
                <div class="customer-info-grid">
                  <p class="label siemreap-bold">អតិថិជន</p>
                  <p class="separator">៖</p>
                  <p class="value metal">${mockData?.customer_name || ''}</p>
                  
                  <p class="label siemreap-bold">អាសយដ្ឋាន</p>
                  <p class="separator">៖</p>
                  <p class="value metal_address wrap-text">${mockData?.customer_address || ''}</p>
                  
                  <p class="label siemreap-bold">ទូរស័ព្ទ</p>
                  <p class="separator">៖</p>
                  <p class="value metal">${formatPhoneNumber(mockData?.customer_phone) || ''}</p>
                  
                  <p class="label siemreap-bold">កាលបរិច្ឆេទ</p>
                  <p class="separator">៖</p>
                  <p class="value metal">${mockData?.date || ''}</p>
                </div>
              </div>
            </div>
            
            <table>
              <thead>
                <tr>
                  <th>ល.រ</th>
                  <th>ប្រភេទ</th>
                  <th>ឯកតា</th>
                  <th>បរិមាណ</th>
                  <th>បរិមាណជាអក្សរ</th>
                  <th>ផ្សេងៗ</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3" class="siemreap-bold" style="text-align: right;">សរុប៖</td>
                  <td>${parseFloat(totalQuantity).toLocaleString('en-US')}</td>
                  <td class="wrap-text">${totalKhmerWord}</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
            
            <div class="info-container" style="margin-top: 5mm;">
              <div class="info-left">
                <p><span class="siemreap-bold">មធ្យោបាយដឹកជញ្ជូន៖ </span><span class="metal">${mockData?.delivery_method || ''}</span></p>
              </div>
              <div class="info-right">
                <p><span class="siemreap-bold">លេខយានយន្ត៖ </span><span class="metal">${mockData?.vehicle_number || ''}</span></p>
                <p><span class="siemreap-bold">ឈ្មោះអ្នកបើកបរ៖ </span><span class="metal">${mockData?.driver_name || ''}</span></p>
              </div>
            </div>
          </div>
          
          <div class="signatures">
            <div class="signature-block">
              <div class="signature-line"></div>
              <p class="moul-regular">អ្នកទទួល</p>
            </div>
            <div class="signature-block">
              <div class="signature-line"></div>
              <p class="moul-regular">អ្នកដឹកជញ្ជូន</p>
            </div>
            <div class="signature-block">
              <div class="signature-line"></div>
              <p class="moul-regular">អ្នកចេញប័ណ្ណ</p>
            </div>
            <div class="signature-block">
              <div class="signature-line"></div>
              <p class="moul-regular">នាយកក្រុមហ៊ុន</p>
            </div>
          </div>
          
          <div class="document-footer">
            <div class="footer-left">
              <small>© ${new Date().getFullYear()} - សង្ខេបប័ណ្ណដឹកជញ្ជូន</small>
            </div>
            <div class="footer-right">
              <small>ទំព័រ 1/1</small>
            </div>
          </div>
        </div>
      </body>
      </html>
    `;


    doc.open();
    doc.write(html);
    doc.close();
  };

  React.useImperativeHandle(ref, () => ({
    print: printContent
  }));

  return <iframe ref={iframeRef} style={{ display: 'none' }} title="print-frame" />;
});

export default DeliveryNotePrint;







