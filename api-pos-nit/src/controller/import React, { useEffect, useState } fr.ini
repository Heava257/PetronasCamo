import React, { useEffect, useState } from "react";
import {
  Button,
  Col,
  Form,
  Input,
  message,
  Modal,
  Row,
  Select,
  Space,
  Table,
  Tag,
  DatePicker,
  Tabs
} from "antd";
import { CiSearch } from "react-icons/ci";
import { MdOutlineCreateNewFolder } from "react-icons/md";
import { IoPersonAddSharp } from "react-icons/io5";
import { formatDateClient, isPermission, request } from "../../util/helper";
import { MdDelete, MdEdit, MdPerson } from "react-icons/md";
import MainPage from "../../component/layout/MainPage";
import { getProfile } from "../../store/profile.store";
import { configStore } from "../../store/configStore";
import { LuUserRoundSearch } from "react-icons/lu";
import dayjs from "dayjs";

function CustomerPage() {
  const { config } = configStore();

  const [form] = Form.useForm();
  const [list, setList] = useState([]);
  const [loading, setLoading] = useState(false);
  const [state, setState] = useState({
    visibleModal: false,
    id: null,
    txtSearch: "",
    user_id: null,
    isEditing: false,
    visibleAssignModal: false,
  });
  
  useEffect(() => {
    const userId = getProfile();
    if (userId) {
      setState((prev) => ({ ...prev, user_id: userId }));
    } else {
      message.error("មិនមានលេខសម្គាល់អ្នកប្រើប្រាស់។ សូមចូលម្តងទៀត។");
    }
  }, []);
  
  useEffect(() => {
    if (state.user_id) {
      getList();
    }
  }, [state.user_id]);
  
  const getList = async () => {
    if (!state.user_id) {
      message.error("តម្រូវឱ្យមានលេខសម្គាល់អ្នកប្រើប្រាស់!");
      return;
    }
    const param = {
      txtSearch: state.txtSearch || "",
    };
    try {
      setLoading(true);
      const { id } = getProfile();
      if (!id) return;
      const res = await request(`customer/${id}`, "get", param);
      setLoading(false);
      if (res?.success) {
        setList(res.list || []);
      } else {
        message.error(res?.message || "បរាជ័យក្នុងការទាញយកបញ្ជីអតិថិជន");
      }
    } catch (error) {
      setLoading(false);
      console.error("Error fetching customer list:", error);
      message.error("បរាជ័យក្នុងការទាញយកបញ្ជីអតិថិជន");
    }
  };
  
  const onClickAddBtn = () => {
    setState((prev) => ({
      ...prev,
      visibleModal: true,
      isEditing: false,
      id: null,
    }));
    form.resetFields();
  };
  
  const onClickEdit = (record) => {
    // Convert the id_card_expiry to dayjs object for DatePicker if available
    const formData = {
      ...record,
      id_card_expiry: record.id_card_expiry ? dayjs(record.id_card_expiry) : undefined
    };
    
    setState((prev) => ({
      ...prev,
      visibleModal: true,
      isEditing: true,
      id: record.id,
    }));
    form.setFieldsValue(formData);
  };
  
  const onClickDelete = (record) => {
    if (!record.id) {
      message.error("មិនមានលេខសម្គាល់អតិថិជន!");
      return;
    }
    Modal.confirm({
      title: "លុបអតិថិជន",
      content: "តើអ្នកពិតជាចង់លុបអតិថិជននេះមែនទេ?",
      onOk: async () => {
        try {
          const res = await request(`customer/${record.id}`, "delete");
          if (res && !res.error) {
            message.success(res.message);
            getList();
          } else {
            message.error(res.message || "អតិថិជននេះកំពុងប្រើប្រាស់និងមិនអាចលុបបានទេ!");
          }
        } catch (error) {
          console.error("Delete Error:", error);
          message.error("មានបញ្ហាកើតឡើងខណៈពេលលុបអតិថិជន។");
        }
      },
    });
  };
  
  const handleModalSubmit = async () => {
    try {
      const values = await form.validateFields();
      
      // Convert the DatePicker value to ISO string format for API
      if (values.id_card_expiry) {
        values.id_card_expiry = values.id_card_expiry.format('YYYY-MM-DD');
      }
      
      const { id, isEditing } = state;
      if (isEditing) {
        const res = await request(`customer/${id}`, "put", values);
        if (res && !res.error) {
          message.success("អតិថិជនត្រូវបានធ្វើបច្ចុប្បន្នភាពដោយជោគជ័យ!");
          setState((prev) => ({ ...prev, visibleModal: false }));
          getList();
        } else {
          message.error("បរាជ័យក្នុងការធ្វើបច្ចុប្បន្នភាពអតិថិជន។");
        }
      } else {
        const res = await request("customer", "post", values);
        if (res && !res.error) {
          message.success("អតិថិជនត្រូវបានបង្កើតដោយជោគជ័យ!");
          setState((prev) => ({ ...prev, visibleModal: false }));
          getList();
        } else {
          message.error("លេខទូរស័ព្ទនេះមានរួចហើយ។ សូមប្រើលេខផ្សេង។");
        }
      }
    } catch (error) {
      console.error("Validation or API error:", error);
    }
  };
  
  const handleModalCancel = () => {
    setState((prev) => ({ ...prev, visibleModal: false }));
    form.resetFields();
  };

  const handleAssignToUserSubmit = async () => {
    try {
      const values = await form.validateFields();
      const { customer_id, assigned_user_id } = values;

      // Call API to assign customer to user
      const res = await request(`customer/user`, "post", {
        customer_id,
        assigned_user_id,
      });

      if (res && !res.error) {
        message.success("អតិថិជនត្រូវបានកំណត់ដោយជោគជ័យ!");
        setState((prev) => ({ ...prev, visibleAssignModal: false }));
        getList(); // Refresh the list
      } else {
        message.error(res.message || "បរាជ័យក្នុងការកំណត់អតិថិជន។");
      }
    } catch (error) {
      console.error("Validation or API error:", error);
      message.error("មានបញ្ហាកើតឡើងខណៈពេលកំណត់អតិថិជន។");
    }
  };

  const onClickAssignToUser = () => {
    setState((prev) => ({
      ...prev,
      visibleAssignModal: true,
    }));
  };
  
  return (
    <MainPage loading={loading}>
      <div className="pageHeader">
        <Space>
          <div>
            <h1 className="khmer-text">ការគ្រប់គ្រងអតិថិជន</h1>
            <p className="english-text">Customer Management</p>
          </div>
          <Input.Search
            onChange={(e) =>
              setState((prev) => ({ ...prev, txtSearch: e.target.value }))
            }
            allowClear
            onSearch={getList}
            placeholder="ស្វែងរកតាមឈ្មោះ"
          />
          <Button className="khmer-text" type="primary" onClick={getList} icon={<CiSearch />}>
            ស្វែងរក
          </Button>
        </Space>
        {isPermission("customer.create") && (
          <Button className="khmer-text" type="primary" onClick={onClickAssignToUser} icon={<IoPersonAddSharp />}>
            បង្កើតអតិថិជនទៅអ្នកប្រើប្រាស់
          </Button>)}
        {isPermission("customer.create") && (
          <Button className="khmer-text" type="primary" onClick={onClickAddBtn} icon={<MdOutlineCreateNewFolder />}>
            បង្កើតថ្មី
          </Button>
        )}
      </div>
      <Table
        rowClassName={() => "pos-row"}
        rowKey="id"
        dataSource={list}
        columns={[
          {
            key: "no",
            title: (
              <div>
                <div className="khmer-text">ល.រ</div>
                <div className="english-text">No</div>
              </div>
            ),
            render: (_, __, index) => index + 1,
            width: 60,
          },
          {
            key: "name",
            title: (
              <div>
                <div className="khmer-text">ឈ្មោះ</div>
                <div className="english-text">Name</div>
              </div>
            ),
            dataIndex: "name",
            sorter: (a, b) => a.name.localeCompare(b.name),
            render: (text) => (
              <div className="truncate-text" title={text || ""}>
                {text || "គ្មាន"}
              </div>
            ),
          },
          {
            key: "type",
            title: (
              <div>
                <div className="khmer-text">ប្រភេទអតិថិជន</div>
                <div className="english-text">Customer Type</div>
              </div>
            ),
            dataIndex: "type",
            render: (type) => (
              <Tag color={type === "special" ? "blue" : "green"}>
                <div>
                  <div className="khmer-text">{type === "special" ? "អតិថិជនពិសេស" : "អតិថិជនធម្មតា"}</div>
                  <div className="english-text">{type === "special" ? "Special" : "Regular"}</div>
                </div>
              </Tag>
            ),
            filters: [
              {
                text: (
                  <div>
                    <div className="khmer-text">អតិថិជនពិសេស</div>
                    <div className="english-text">Special</div>
                  </div>
                ), value: "special"
              },
              {
                text: (
                  <div>
                    <div className="khmer-text">អតិថិជនធម្មតា</div>
                    <div className="english-text">Regular</div>
                  </div>
                ), value: "regular"
              },
            ],
            onFilter: (value, record) => record.type === value,
          },
          {
            key: "email",
            title: (
              <div>
                <div className="khmer-text">អ៊ីមែល</div>
                <div className="english-text">Email</div>
              </div>
            ),
            dataIndex: "email",
          },
          {
            key: "tel",
            title: (
              <div>
                <div className="khmer-text">លេខទូរស័ព្ទ</div>
                <div className="english-text">Tel</div>
              </div>
            ),
            dataIndex: "tel",
          },
          {
            key: "id_card_number",
            title: (
              <div>
                <div className="khmer-text">លេខអត្តសញ្ញាណបណ្ណ</div>
                <div className="english-text">ID Card Number</div>
              </div>
            ),
            dataIndex: "id_card_number",
          },
          {
            key: "address",
            title: (
              <div>
                <div className="khmer-text">អាសយដ្ឋាន</div>
                <div className="english-text">Address</div>
              </div>
            ),
            dataIndex: "address",
            ellipsis: true,
          },
          {
            key: "spouse_name",
            title: (
              <div>
                <div className="khmer-text">ឈ្មោះប្តី/ប្រពន្ធ</div>
                <div className="english-text">Spouse Name</div>
              </div>
            ),
            dataIndex: "spouse_name",
          },
          {
            key: "guarantor_name",
            title: (
              <div>
                <div className="khmer-text">ឈ្មោះអ្នកធានា</div>
                <div className="english-text">Guarantor Name</div>
              </div>
            ),
            dataIndex: "guarantor_name",
          },
          {
            key: "created_at",
            title: (
              <div>
                <div className="khmer-text">កាលបរិច្ឆេទបង្កើត</div>
                <div className="english-text">Created Date</div>
              </div>
            ),
            dataIndex: "created_at",
            render: (value) => dayjs(value).format("YYYY-MM-DD h:mm A"),
          },
          {
            key: "status",
            title: (
              <div>
                <div className="khmer-text">ស្ថានភាព</div>
                <div className="english-text">Status</div>
              </div>
            ),
            dataIndex: "status",
            render: (status) => (
              <Tag color={status === 1 ? "green" : "red"}>
                <div>
                  <div className="khmer-text">{status === 1 ? "សកម្ម" : "អសកម្ម"}</div>
                  <div className="english-text">{status === 1 ? "Active" : "Inactive"}</div>
                </div>
              </Tag>
            ),
            filters: [
              {
                text: (
                  <div>
                    <div className="khmer-text">សកម្ម</div>
                    <div className="english-text">Active</div>
                  </div>
                ), value: 1
              },
              {
                text: (
                  <div>
                    <div className="khmer-text">អសកម្ម</div>
                    <div className="english-text">Inactive</div>
                  </div>
                ), value: 0
              },
            ],
            onFilter: (value, record) => record.status === value,
          },
          {
            key: "action",
            title: (
              <div>
                <div className="khmer-text">សកម្មភាព</div>
                <div className="english-text">Action</div>
              </div>
            ),
            align: "center",
            width: 120,
            render: (_, record) => (
              <Space>
                {isPermission("customer.update") && (
                  <Button
                    type="primary"
                    icon={<MdEdit />}
                    onClick={() => onClickEdit(record)}
                    size="small"
                  />)}
                {isPermission("customer.update") && (
                  <Button
                    type="primary"
                    danger
                    icon={<MdDelete />}
                    onClick={() => onClickDelete(record)}
                    size="small"
                  />)}
              </Space>
            ),
          },
        ]}
      />

      <Modal
        title={
          <div>
            <span className="khmer-text">ចាត់ចែងអតិថិជនទៅអ្នកប្រើប្រាស់</span>
          </div>
        }
        visible={state.visibleAssignModal}
        onOk={handleAssignToUserSubmit}
        onCancel={() => setState((prev) => ({ ...prev, visibleAssignModal: false }))}
      >
        <Form form={form} layout="vertical">
          <Form.Item
            label={
              <div>
                <span className="khmer-text">អតិថិជន</span>
              </div>
            }
            name="customer_id"
            rules={[{ required: true, message: "តម្រូវឱ្យមានអតិថិជន" }]}
          >
            <Select placeholder="ជ្រើសរើសអតិថិជន">
              {list.map((customer) => (
                <Select.Option key={customer.id} value={customer.id}>
                  {customer.name}
                </Select.Option>
              ))}
            </Select>
          </Form.Item>
          <Form.Item
            label={
              <div>
                <span className="khmer-text">អ្នកប្រើប្រាស់</span>
              </div>
            }
            name="assigned_user_id"
            rules={[{ required: true, message: "តម្រូវឱ្យមានអ្នកប្រើប្រាស់" }]}
          >
            <Select
              style={{ width: 300 }}
              allowClear
              placeholder="ជ្រើសរើសអ្នកប្រើប្រាស់"
              value={state.user_id || undefined}
              options={config?.user || []}
              onChange={(value) => {
                setState((prev) => ({
                  ...prev,
                  user_id: value || null,
                }));
              }}
              suffixIcon={<LuUserRoundSearch />}
            />
          </Form.Item>
        </Form>
      </Modal>
      <Modal
        title={
          <div>
            <span className="khmer-text">{state.isEditing ? "កែសម្រួលអតិថិជន" : "បង្កើតអតិថិជន"}</span>
          </div>
        }
        visible={state.visibleModal}
        onOk={handleModalSubmit}
        onCancel={handleModalCancel}
        width={700}
      >
        <Form form={form} layout="vertical">
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                label={
                  <div>
                    <span className="khmer-text">ឈ្មោះ</span>
                  </div>
                }
                name="name"
                rules={[{ required: true, message: "តម្រូវឱ្យមានឈ្មោះ" }]}
              >
                <Input />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                label={
                  <div>
                    <span className="khmer-text">ទូរស័ព្ទ</span>
                  </div>
                }
                name="tel"
                rules={[{ required: true, message: "តម្រូវឱ្យមានលេខទូរស័ព្ទ" }]}
              >
                <Input />
              </Form.Item>
            </Col>
          </Row>
          
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                label={
                  <div>
                    <span className="khmer-text">អ៊ីមែល</span>
                  </div>
                }
                name="email"
                rules={[{ required: true, message: "តម្រូវឱ្យមានអ៊ីមែល" }]}
              >
                <Input />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                label={
                  <div>
                    <span className="khmer-text">ប្រភេទអតិថិជន</span>
                    <span className="english-text">Customer Type</span>
                  </div>
                }
                name="type"
                rules={[{ required: true, message: "តម្រូវឱ្យមានប្រភេទអតិថិជន" }]}
              >
                <Select>
                  <Select.Option value="regular">
                    <div>
                      <span className="khmer-text">អតិថិជនធម្មតា</span>
                      <span