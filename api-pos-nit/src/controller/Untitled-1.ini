// Fix: Replace this in your Table action column (inside the Drawer)

{
  title: <span className="khmer-text">សកម្មភាព</span>,
  key: "action",
  render: (_, record) => (
    <Space size="small" wrap>
      {/* View Details Button */}
      <Button
        type="default"
        size="small"
        icon={<MdRemoveRedEye />}
        onClick={() => {
          Modal.info({
            title: <span className="khmer-font">ព័ត៌មានលម្អិតវិក័យប័ត្រ</span>,
            width: 600,
            content: (
              <div style={{ marginTop: '20px' }}>
                <Descriptions bordered column={1} size="small">
                  <Descriptions.Item
                    label={<span className="khmer-font">លេខវិក័យប័ត្រ</span>}
                  >
                    <span className="english-text">{record.order_no}</span>
                  </Descriptions.Item>
                  <Descriptions.Item
                    label={<span className="khmer-font">ថ្ងៃបញ្ជាទិញ</span>}
                  >
                    <span className="english-text">{formatDateClient(record.order_date)}</span>
                  </Descriptions.Item>
                  <Descriptions.Item
                    label={<span className="khmer-font">ថ្ងៃប្រគល់ទំនិញ</span>}
                  >
                    <span className="english-text">{formatDateClient(record.delivery_date)}</span>
                  </Descriptions.Item>
                  <Descriptions.Item
                    label={<span className="khmer-font">ទឹកប្រាក់សរុប</span>}
                  >
                    <span className="english-text">{formatCurrency(record.total_amount)}</span>
                  </Descriptions.Item>
                  <Descriptions.Item
                    label={<span className="khmer-font">បានបង់</span>}
                  >
                    <span className="english-text">{formatCurrency(record.paid_amount)}</span>
                  </Descriptions.Item>
                  <Descriptions.Item
                    label={<span className="khmer-font">នៅជំពាក់</span>}
                  >
                    <Tag color="red" className="english-text">
                      {formatCurrency(record.due_amount)}
                    </Tag>
                  </Descriptions.Item>
                  <Descriptions.Item
                    label={<span className="khmer-font">ស្ថានភាព</span>}
                  >
                    <span className="khmer-text">{record.payment_status}</span>
                  </Descriptions.Item>
                  {record.product_details && record.product_details.length > 0 && (
                    <Descriptions.Item
                      label={<span className="khmer-font">ផលិតផល</span>}
                    >
                      <ul style={{ margin: 0, paddingLeft: '20px' }}>
                        {record.product_details.map((item, idx) => (
                          <li key={idx} className="khmer-text">
                            {item.category_name} - {item.quantity} x {formatCurrency(item.unit_price)} = {formatCurrency(item.total_amount)}
                          </li>
                        ))}
                      </ul>
                    </Descriptions.Item>
                  )}
                </Descriptions>
              </div>
            ),
            okText: <span className="khmer-text">ឹងយល់ព្រម</span>
          });
        }}
        className="view-details-btn"
      >
        <span className="khmer-text">មើល</span>
      </Button>

      {/* Payment History Button - FIXED */}
      <Button
        type="primary"
        size="small"
        icon={<MdOutlinePayment />}
        onClick={() => {
          setPaymentHistoryVisible(true);
          // Store the current record for the modal to use
          setCurrentOrder(record);
        }}
      >
        <span className="khmer-text">ប្រវត្តិការបង់ប្រាក់</span>
      </Button>

      {/* Make Payment Button */}
      {parseFloat(record.due_amount) > 0 && (
        <Button
          type="primary"
          size="small"
          icon={<MdPayment />}
          onClick={() => handleMakePayment(record)}
          className="pay-button"
        >
          <span className="khmer-text">បង់ប្រាក់</span>
        </Button>
      )}

      {/* Edit Button */}
      {isPermission("customer.getone") && (
        <Button
          type="default"
          size="small"
          icon={<MdEdit />}
          onClick={() => handleEditInvoice(record)}
          className="edit-button"
        >
          <span className="khmer-text">កែប្រែ</span>
        </Button>
      )}

      {/* Delete Button */}
      <Popconfirm
        title={<span className="khmer-text">តើអ្នកចង់លុបវិក័យប័ត្រនេះមែនទេ?</span>}
        onConfirm={() => handleDeleteInvoice(record)}
        okText={<span className="khmer-text">បាទ</span>}
        cancelText={<span className="khmer-text">ទេ</span>}
        okButtonProps={{ loading: deleteLoading }}
      >
        {isPermission("customer.getone") && (
          <Button
            type="primary"
            danger
            size="small"
            icon={<MdDelete />}
            className="delete-button"
          >
            <span className="khmer-text">លុប</span>
          </Button>
        )}
      </Popconfirm>

      {/* Print Button */}
      <Button
        type="default"
        size="small"
        icon={<FaFileExcel />}
        onClick={() => {
          const printWindow = window.open('', '', 'height=600,width=800');
          printWindow.document.write(`
            <html>
              <head>
                <title>${record.order_no}</title>
                <style>
                  body { font-family: Arial; margin: 20px; }
                  table { width: 100%; border-collapse: collapse; }
                  th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                  th { background-color: #f2f2f2; }
                  .header { text-align: center; margin-bottom: 20px; }
                  .total { font-weight: bold; background-color: #f9f9f9; }
                </style>
              </head>
              <body>
                <div class="header">
                  <h2>វិក័យប័ត្របញ្ជាលេខ: ${record.order_no}</h2>
                </div>
                <table>
                  <tr>
                    <th>ព័ត៌មាន</th>
                    <th>តម្លៃ</th>
                  </tr>
                  <tr>
                    <td>ថ្ងៃបញ្ជាទិញ</td>
                    <td>${formatDateClient(record.order_date)}</td>
                  </tr>
                  <tr>
                    <td>ថ្ងៃប្រគល់ទំនិញ</td>
                    <td>${formatDateClient(record.delivery_date)}</td>
                  </tr>
                  <tr>
                    <td>ទឹកប្រាក់សរុប</td>
                    <td>${formatCurrency(record.total_amount)}</td>
                  </tr>
                  <tr>
                    <td>បានបង់</td>
                    <td>${formatCurrency(record.paid_amount)}</td>
                  </tr>
                  <tr class="total">
                    <td>នៅជំពាក់</td>
                    <td>${formatCurrency(record.due_amount)}</td>
                  </tr>
                </table>
              </body>
            </html>
          `);
          printWindow.document.close();
          printWindow.print();
        }}
        className="print-button"
      >
        <span className="khmer-text">បោះពុម្ព</span>
      </Button>
    </Space>
  ),
  width: 300
}

// ============================================
// ADD THIS STATE at the top with other states
// ============================================

const [currentOrder, setCurrentOrder] = useState(null);

// ============================================
// THEN UPDATE the PaymentHistoryModal call at bottom
// ============================================

<PaymentHistoryModal
  visible={paymentHistoryVisible}
  order_id={currentOrder?.order_id}
  onClose={() => {
    setPaymentHistoryVisible(false);
    setCurrentOrder(null);
  }}
  onRefresh={() => getList()}
/>